import { useSession } from "next-auth/react";
import Script from "next/script";
import Footer from "../components/Footer";
import Header from "../components/Header";
import Head from "next/head";
import useSWR from "swr";
import Image from "next/image";
import { getCreditsByAmount } from "../utils/payAmountTypes"
import { useRouter } from "next/router";
import { useEffect, useState } from "react";
import { Routes, Route, useParams } from 'react-router-dom';


// 原来是作为支付返回的中间页面，后来采用回调URL函数的方式，就放弃掉了这个页面
// 所以这个页面是无用的
// @ts-ignore
export default function checkPayment(req, res) {
  
  const { data: session } = useSession();
  const router = useRouter();

  const fetcher = (url: string) => fetch(url).then((resp) => resp.json());
  const { data } = useSWR("/api/remaining", fetcher);
  const {out_trade_no} = useParams();
  console.error("------------outside------------");
  console.error(out_trade_no);
 // console.error(req.query.out_trade_no);
  


   console.error(req);  
  
  
  useEffect(() => {
    addCredits();
  }, []);

  
 async function addCredits(){
   alert(out_trade_no);
   alert(router);
   alert(2);
   alert(req);
   alert(3);
   alert(req.formData);

   console.error(req.query.out_trade_no);
   
   console.error(router.query.toString());
   // @ts-ignore
   console.error(router.query.bizContent);
   // @ts-ignore
   alert(router.query.bizContent);
   // @ts-ignore
   alert(router.query.bizContent.out_trade_no);
    if(router == null){
      alert("支付发生意外失败，请和网站管理员联系！");
    }else{
      alert(3);
      const {out_trade_no, total_amount} = router.query;
      console.error(router.query);
      alert(router.query);
      alert(4);
      alert(out_trade_no);
      alert(total_amount);
      
      
      const params = {
        out_trade_no: router.query.out_trade_no,
//        money: router.query.total_amount,
//        credits: getCreditsByAmount(router.query.total_amount as string),
//        payMethod: "ALIPAY",
      };
      try {
        const response = await fetch('/api/addCredits', {
          method: 'POST',
          body: JSON.stringify(params),
        });

        const data = await response.json();
//        window.location.href = "/buy-credits"; // 跳转到支付页面
      } catch (error) {
        console.error(error);
      }
   }
};

  
  return (
    <div className="flex mx-auto max-w-7xl overflow-visible flex-col items-center justify-center py-2 min-h-screen">
      <Head>
        <title>AI菩提</title>
      </Head>
      <Header/>
      <main className="flex flex-1 flex-col">
        <div className="mx-auto max-w-7xl px-6 lg:px-8">
          <div className="mx-auto max-w-4xl text-center">
            <p className="mt-2 text-4xl font-bold tracking-tight text-white sm:text-5xl">
              正在检验支付结果，请稍后......
            </p>
          </div>
        </div>
        <p className="mx-auto mt-6 max-w-2xl text-center text-lg leading-8 text-gray-500 mb-10">
          你现在有{" "}
          <span className="font-semibold text-gray-400">
            {data?.remainingGenerations}{"个提子 "}
          </span>
          。 
        </p>
  
      </main>
      
      
      <Footer />
    </div>
  );
}
